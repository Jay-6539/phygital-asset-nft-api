//
//  OvalOfficeHistoryModal.swift
//  Phygital Asset
//
//  Oval Office ÂéÜÂè≤ËÆ∞ÂΩïÂºπÁ™óÔºàÂåÖÂê´ ZOOM IN ÊåâÈíÆÔºâ
//

import SwiftUI

struct OvalOfficeHistoryModal: View {
    let building: Treasure?
    let appGreen: Color
    let onStartCheckIn: (String) -> Void
    let onZoomIn: () -> Void // Êñ∞Â¢ûÔºöZOOM IN ÂõûË∞É
    let onClose: () -> Void
    let nfcUuid: String? // Êñ∞Â¢ûÔºöNFC UUIDÔºåÁî®‰∫éËé∑ÂèñÁâπÂÆöNFCÁöÑÂéÜÂè≤ËÆ∞ÂΩï
    
    @State private var checkIns: [BuildingCheckIn] = []
    @State private var ovalOfficeCheckIns: [OvalOfficeCheckIn] = []
    @State private var isLoading = false
    
    // ÂàùÂßãÂåñÊñπÊ≥ï
    init(building: Treasure?, appGreen: Color, onStartCheckIn: @escaping (String) -> Void, onZoomIn: @escaping () -> Void, onClose: @escaping () -> Void, nfcUuid: String? = nil) {
        self.building = building
        self.appGreen = appGreen
        self.onStartCheckIn = onStartCheckIn
        self.onZoomIn = onZoomIn
        self.onClose = onClose
        self.nfcUuid = nfcUuid
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // Ê†áÈ¢òÊ†è
            HStack {
                Text("Oval Office History")
                    .font(.title2)
                    .fontWeight(.bold)
                    .foregroundColor(.primary)
                
                Spacer()
                
                Button(action: {
                    onClose()
                }) {
                    Image(systemName: "xmark.circle.fill")
                        .font(.title2)
                        .foregroundColor(.gray)
                }
            }
            .padding()
            .background(Color(.systemBackground))
            .padding(.bottom, 10)
            
            // Âª∫Á≠ë‰ø°ÊÅØ
            if let building = building {
                VStack(spacing: 16) {
                    Text(building.name)
                        .font(.title2)
                        .fontWeight(.bold)
                        .foregroundColor(.primary)
                    
                    Text(building.address)
                        .font(.body)
                        .foregroundColor(.secondary)
                        .multilineTextAlignment(.center)
                }
                .padding()
            }
            
            // ÂéÜÂè≤ËÆ∞ÂΩïÂå∫Âüü
            ScrollView {
                VStack(spacing: 16) {
                    if isLoading {
                        ProgressView()
                            .scaleEffect(1.5)
                            .padding(.vertical, 40)
                    } else if checkIns.isEmpty && ovalOfficeCheckIns.isEmpty {
                        // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
                        VStack(spacing: 12) {
                            Image(systemName: "clock.arrow.circlepath")
                                .font(.system(size: 50))
                                .foregroundColor(.gray.opacity(0.5))
                            Text("No check-in history yet")
                                .font(.subheadline)
                                .foregroundColor(.secondary)
                        }
                        .frame(maxWidth: .infinity)
                        .padding(.vertical, 40)
                    } else {
                        // ÊòæÁ§∫ÂéÜÂè≤ËÆ∞ÂΩï
                        ForEach(checkIns) { checkIn in
                            BuildingCheckInRow(checkIn: checkIn)
                        }
                        
                        ForEach(ovalOfficeCheckIns) { checkIn in
                            OvalOfficeCheckInRow(checkIn: checkIn, appGreen: appGreen)
                        }
                    }
                }
                .padding(.horizontal, 20)
                .padding(.bottom, 20)
            }
            .background(Color(.systemBackground))
            
            // Check-in ÊåâÈíÆ
            Button(action: {
                if let building = building {
                    Logger.debug("Starting check-in for Oval Office: \(building.name)")
                    onStartCheckIn(building.id)
                }
            }) {
                Text("Check In Mine")
                    .font(.headline)
                    .fontWeight(.semibold)
                    .foregroundColor(appGreen)
                    .frame(maxWidth: .infinity)
                    .padding()
                    .background {
                        ZStack {
                            Color.clear.background(.ultraThinMaterial)
                            LinearGradient(
                                gradient: Gradient(colors: [
                                    appGreen.opacity(0.15),
                                    appGreen.opacity(0.05)
                                ]),
                                startPoint: .top,
                                endPoint: .bottom
                            )
                        }
                    }
                    .cornerRadius(12)
                    .overlay(
                        RoundedRectangle(cornerRadius: 12)
                            .strokeBorder(
                                LinearGradient(
                                    gradient: Gradient(stops: [
                                        .init(color: Color.white.opacity(0.6), location: 0.0),
                                        .init(color: Color.white.opacity(0.0), location: 0.3),
                                        .init(color: appGreen.opacity(0.2), location: 0.7),
                                        .init(color: appGreen.opacity(0.4), location: 1.0)
                                    ]),
                                    startPoint: .topLeading,
                                    endPoint: .bottomTrailing
                                ),
                                lineWidth: 1.5
                            )
                    )
                    .shadow(color: appGreen.opacity(0.2), radius: 8, x: 0, y: 4)
                    .shadow(color: Color.black.opacity(0.1), radius: 2, x: 0, y: 1)
            }
            .padding(.horizontal, 20)
            .padding(.top, 10)
            
            // ZOOM IN ÊåâÈíÆ
            Button(action: {
                Logger.debug("üîç Zoom In button tapped - opening Oval Office map")
                onZoomIn()
            }) {
                Text("Zoom In")
                    .font(.headline)
                    .fontWeight(.semibold)
                    .foregroundColor(appGreen)
                .frame(maxWidth: .infinity)
                .padding()
                .background {
                    ZStack {
                        Color.clear.background(.ultraThinMaterial)
                        LinearGradient(
                            gradient: Gradient(colors: [
                                appGreen.opacity(0.15),
                                appGreen.opacity(0.05)
                            ]),
                            startPoint: .top,
                            endPoint: .bottom
                        )
                    }
                }
                .cornerRadius(12)
                .overlay(
                    RoundedRectangle(cornerRadius: 12)
                        .strokeBorder(
                            LinearGradient(
                                gradient: Gradient(stops: [
                                    .init(color: Color.white.opacity(0.6), location: 0.0),
                                    .init(color: Color.white.opacity(0.0), location: 0.3),
                                    .init(color: appGreen.opacity(0.2), location: 0.7),
                                    .init(color: appGreen.opacity(0.4), location: 1.0)
                                ]),
                                startPoint: .topLeading,
                                endPoint: .bottomTrailing
                            ),
                            lineWidth: 1.5
                        )
                )
                .shadow(color: appGreen.opacity(0.2), radius: 8, x: 0, y: 4)
                .shadow(color: Color.black.opacity(0.1), radius: 2, x: 0, y: 1)
            }
            .padding(.horizontal, 20)
            .padding(.top, 10)
            .padding(.bottom, 20)
        }
        .frame(maxWidth: 340, maxHeight: 600)
        .background(Color(.systemBackground))
        .cornerRadius(16)
        .shadow(radius: 20)
        .onAppear {
            Logger.debug("üèõÔ∏è OvalOfficeHistoryModal Â∑≤ÊòæÁ§∫")
            Logger.debug("   building: \(building?.name ?? "nil")")
            Logger.debug("   nfcUuid: \(nfcUuid ?? "nil")")
            loadHistory()
        }
    }
    
    // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
    private func loadHistory() {
        Logger.debug("üìã ========== ÂºÄÂßãÂä†ËΩΩOval OfficeÂéÜÂè≤ËÆ∞ÂΩï ==========")
        Logger.debug("üìã nfcUuid: '\(nfcUuid ?? "nil")'")
        Logger.debug("üìã building: \(building?.name ?? "nil")")
        
        isLoading = true
        
        Task {
            do {
                var fetchedCheckIns: [BuildingCheckIn] = []
                var fetchedOvalOfficeCheckIns: [OvalOfficeCheckIn] = []
                
                if let nfcUuid = nfcUuid {
                    // Ê†πÊçÆNFC UUIDËé∑ÂèñÊâÄÊúâË°®ÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                    Logger.success("‚úÖ Ê£ÄÊµãÂà∞ NFC UUIDÔºåÂ∞Ü‰ªé‰∏§‰∏™Ë°®Êü•ËØ¢")
                    Logger.debug("üìã Êü•ËØ¢ÁöÑ NFC UUID: '\(nfcUuid)'")
                    
                    // 1. ‰ªé threads Ë°®Ëé∑Âèñ
                    do {
                        Logger.debug("üìã [1/2] ÂºÄÂßãÊü•ËØ¢ threads Ë°®...")
                        fetchedCheckIns = try await BuildingCheckInManager.shared.getCheckInsByNFC(nfcUuid: nfcUuid)
                        Logger.success("üìã [1/2] ‚úÖ ‰ªé threads Ëé∑ÂèñÂà∞ \(fetchedCheckIns.count) Êù°ËÆ∞ÂΩï")
                    } catch {
                        Logger.error("üìã [1/2] ‚ùå ‰ªé threads Ëé∑ÂèñÂ§±Ë¥•: \(error.localizedDescription)")
                    }
                    
                    // 2. ‰ªé oval_office_threads Ë°®Ëé∑Âèñ
                    do {
                        Logger.debug("üìã [2/2] ÂºÄÂßãÊü•ËØ¢ oval_office_threads Ë°®...")
                        fetchedOvalOfficeCheckIns = try await OvalOfficeCheckInManager.shared.getCheckInsByNFC(nfcUuid: nfcUuid)
                        Logger.success("üìã [2/2] ‚úÖ ‰ªé oval_office_threads Ëé∑ÂèñÂà∞ \(fetchedOvalOfficeCheckIns.count) Êù°ËÆ∞ÂΩï")
                    } catch {
                        Logger.error("üìã [2/2] ‚ùå ‰ªé oval_office_threads Ëé∑ÂèñÂ§±Ë¥•: \(error.localizedDescription)")
                    }
                    
                } else if let building = building {
                    // Ê†πÊçÆÂª∫Á≠ëIDËé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÔºàÂè™Êü• threadsÔºâ
                    Logger.debug("üìã Ê†πÊçÆÂª∫Á≠ëIDËé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩï: \(building.id)")
                    fetchedCheckIns = try await BuildingCheckInManager.shared.getCheckIns(for: building.id)
                    Logger.success("üìã Ëé∑ÂèñÂà∞ \(fetchedCheckIns.count) Êù°Âª∫Á≠ëÂéÜÂè≤ËÆ∞ÂΩï")
                } else {
                    Logger.warning("üìã Ê≤°ÊúâÊåáÂÆöÂª∫Á≠ëÊàñNFC UUID")
                }
                
                let totalCount = fetchedCheckIns.count + fetchedOvalOfficeCheckIns.count
                
                await MainActor.run {
                    self.checkIns = fetchedCheckIns
                    self.ovalOfficeCheckIns = fetchedOvalOfficeCheckIns
                    self.isLoading = false
                    Logger.success("üìã Oval OfficeÂéÜÂè≤ËÆ∞ÂΩïÂä†ËΩΩÂÆåÊàêÔºåÂÖ± \(totalCount) Êù°")
                }
            } catch {
                await MainActor.run {
                    self.isLoading = false
                    Logger.error("‚ùå Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•: \(error.localizedDescription)")
                }
            }
        }
    }
}

